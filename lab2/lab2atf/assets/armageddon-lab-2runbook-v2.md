# ARMAGEDDON — Lab 2A
## CloudFront Origin Cloaking: Architecture Documentation & Incident Runbook

| Field | Value |
|---|---|
| Project | dawgs-armageddon |
| Apex Domain | thedawgs2025.click |
| App Domain | app.thedawgs2025.click |
| Account ID | 778185677715 |
| Region | us-east-1 |
| Date | February 24, 2026 |

---

## 1. Architecture Overview

The Lab 2A architecture places CloudFront as the sole public entry point to a private application stack. No component behind CloudFront is directly reachable from the internet.

### 1.1 Traffic Flow

```
Internet → CloudFront (+WAF) → ALB (locked) → Private EC2 → RDS
```

### 1.2 Security Layers

| Layer | Type | Enforcement |
|---|---|---|
| Layer 1 | Network (SG) | ALB SG allows port 80 inbound only from CloudFront prefix list `pl-3b927c52` |
| Layer 2 | Application (ALB Listener) | HTTPS listener default returns 403. Only requests with `X-Origin-Verify` header are forwarded |
| Layer 3 | Edge (WAF) | AWS Managed Rules enforced at CloudFront edge before traffic reaches ALB |

### 1.3 Key Resource IDs

| Resource | ID / Value |
|---|---|
| CloudFront Distribution | `E3VBKBF4IR3L08` |
| CloudFront Domain | `d1nxxrugh4xmd5.cloudfront.net` |
| ALB DNS | `lab-alb01-1858042517.us-east-1.elb.amazonaws.com` |
| ALB ARN | `arn:aws:elasticloadbalancing:us-east-1:778185677715:loadbalancer/app/lab-alb01/f817462bee64fa50` |
| ALB SG (HTTP) | `sg-0b3aa62b1416d41bb` — `lab-alb-sg01` |
| ALB SG (HTTPS) | `sg-05f03fb98d911ab03` — `lab-alb-sg02` |
| Target Group ARN | `arn:aws:elasticloadbalancing:us-east-1:778185677715:targetgroup/lab-tg01/8f142282efda225d` |
| EC2 Instance | `i-0b5b4f5716a21c044` |
| EC2 Private Instance | `i-03755b30cffb01a1e` |
| CloudFront Prefix List | `pl-3b927c52` (45 CIDRs) |
| ACM Cert (ALB) | `arn:aws:acm:us-east-1:778185677715:certificate/089a9362-6872-40f1-aa23-c8cafd8076b5` |
| ACM Cert (CloudFront) | `arn:aws:acm:us-east-1:778185677715:certificate/163286bb-6f76-4e42-8d4e-ac7c4516b659` |
| WAF (CloudFront scope) | `lab-cf-waf01` / `87ca0e7e-1921-488f-ae0d-a5c1ed04faa9` |
| WAF (Regional) | `lab-waf01` / `a540394d-ed66-438d-8593-ed5b5274a091` |
| Route53 Hosted Zone | `Z0717862367KSPKDBWGDE` |
| RDS Endpoint | `lab-rds01.c89ykq22i31z.us-east-1.rds.amazonaws.com` |
| VPC | `vpc-067d2199c451b6638` |
| SNS Topic | `arn:aws:sns:us-east-1:778185677715:lab-db-incidents` |

---

## 2. Terraform Architecture Decisions

### 2.1 Dual Security Group Design

The standard design uses a single ALB SG for both port 80 and 443 ingress. A quota limit forces a split-SG architecture.

> **Why:** AWS counts each CIDR in a managed prefix list as an individual rule against the SG quota. `pl-3b927c52` has 45 CIDRs. Two prefix-list rules (port 80 + port 443) would consume 90 rule slots, exceeding the default account limit of 60.

- `lab-alb-sg01` — handles port 80 (HTTP), locked to CloudFront prefix list
- `lab-alb-sg02` — handles port 443 (HTTPS), locked to CloudFront prefix list

> **Note:** A service quota increase to 150 has been requested. Once approved, both rules can be consolidated into a single SG.

### 2.2 CloudFront Origin Protocol: `http-only`

> **Why:** CloudFront connects to the ALB using the ALB's own DNS name as the SNI hostname during TLS negotiation. The ALB certificate covers `thedawgs2025.click` — not the ALB DNS name. This SNI mismatch causes `ClientTLSNegotiationErrorCount` errors and prevents CloudFront from reaching the origin entirely. Switching to `http-only` eliminates the SNI mismatch. The `X-Origin-Verify` header provides application-layer security; CloudFront-to-ALB traffic transits AWS backbone infrastructure.

```hcl
custom_origin_config {
  http_port              = 80
  https_port             = 443
  origin_protocol_policy = "http-only"
  origin_ssl_protocols   = ["TLSv1.2"]
}
```

### 2.3 `random_password` as Secret Source of Truth

The origin secret is generated by Terraform and shared between CloudFront and the ALB listener rule. Both reference the same resource — no hardcoded strings.

```hcl
resource "random_password" "dawgs-armageddon_origin_header_value01" {
  length  = 32
  special = false
}
```

CloudFront custom header:
```hcl
custom_header {
  name  = var.cloudfront_origin_header_name
  value = random_password.dawgs-armageddon_origin_header_value01.result
}
```

ALB listener rule condition:
```hcl
values = [random_password.dawgs-armageddon_origin_header_value01.result]
```

> **Important:** On `terraform destroy` / fresh `terraform apply`, a new random value is generated. Both CloudFront and the ALB listener rule update together in the same apply, so they remain in sync.

### 2.4 HTTP Listener: Forward (not Redirect)

> **Why:** CloudFront connects to the ALB on port 80 (`http-only`). If the HTTP listener redirects to HTTPS, the `Location` header contains the ALB's own DNS name — not `app.thedawgs2025.click`. CloudFront receives this and reports a 301 error. Viewer-facing HTTPS enforcement is handled by CloudFront's `viewer_protocol_policy = "redirect-to-https"`.

```hcl
default_action {
  type             = "forward"
  target_group_arn = aws_lb_target_group.dawgs-armageddon_tg01.arn
}
```

### 2.5 CloudFront Distribution Aliases (Both Domains)

Both the apex and subdomain must be in the distribution `aliases` list or CloudFront rejects requests for the unlisted domain with 403.

```hcl
aliases = [local.cf_fqdn, var.domain_name]  # app.thedawgs2025.click + thedawgs2025.click
```

### 2.6 EC2 Ingress from Both ALB SGs

Because the ALB uses two security groups, the EC2 security group must reference both or health checks from one SG time out.

```hcl
resource "aws_vpc_security_group_ingress_rule" "dawgs-armageddon_ec2_ingress_from_alb_sg01" {
  security_group_id            = aws_security_group.dawgs-armageddon_ec2_sg01.id
  referenced_security_group_id = aws_security_group.dawgs-armageddon_alb_sg01.id
  from_port   = 80
  ip_protocol = "tcp"
  to_port     = 80
}

resource "aws_vpc_security_group_ingress_rule" "dawgs-armageddon_ec2_ingress_from_alb_sg02" {
  security_group_id            = aws_security_group.dawgs-armageddon_ec2_sg01.id
  referenced_security_group_id = aws_security_group.dawgs-armageddon_alb_sg02.id
  from_port   = 80
  ip_protocol = "tcp"
  to_port     = 80
}
```

---

## 3. Session Incident Log & Resolutions

### Issue 1 — Apex Domain Bypassing CloudFront

**Symptom:**
```
nslookup thedawgs2025.click → 3.223.49.245, 54.165.138.75  (ALB IPs)
nslookup app.thedawgs2025.click → 52.222.205.x  (CloudFront IPs)
```

**Root cause:** The apex Route53 A record was aliased to the ALB directly. When `app.` was moved to CloudFront, the apex record was not updated.

**Diagnostic:**
```bash
aws route53 list-resource-record-sets \
  --hosted-zone-id Z0717862367KSPKDBWGDE \
  --query "ResourceRecordSets[?Name=='thedawgs2025.click.' && Type=='A']"
```

**Resolution:** Added apex alias record to `cloudfront-lab-2a-distribution.tf`:
```hcl
resource "aws_route53_record" "dawgs-armageddon_cf_apex_alias" {
  count           = var.enable_cloudfront ? 1 : 0
  zone_id         = local.dawgs-armageddon_zone_id
  name            = var.domain_name
  type            = "A"
  allow_overwrite = true

  alias {
    name                   = aws_cloudfront_distribution.dawgs-armageddon_cf01[0].domain_name
    zone_id                = aws_cloudfront_distribution.dawgs-armageddon_cf01[0].hosted_zone_id
    evaluate_target_health = false
  }
}
```

And added `var.domain_name` to the distribution aliases:
```hcl
aliases = [local.cf_fqdn, var.domain_name]
```

---

### Issue 2 — Apex 403 from CloudFront After Route53 Update

**Symptom:**
```
curl -I thedawgs2025.click → HTTP/1.1 403 Forbidden, Server: CloudFront
curl -I https://thedawgs2025.click → SSL handshake failure
```

**Root cause:** Route53 apex record was updated to point at CloudFront, but `thedawgs2025.click` was not in the distribution's `aliases` list. CloudFront rejected requests for an unrecognized domain.

**Resolution:** Added `var.domain_name` to `aliases` in the distribution resource and ran `terraform apply -target=aws_route53_record.dawgs-armageddon_cf_apex_alias[0]`.

---

### Issue 3 — Route53 Apex Record Not Updating Despite Being in State

**Symptom:** `terraform state list` showed the apex record in state but AWS still showed the ALB alias after apply.

**Resolution:** Ran targeted apply to force the update:
```bash
terraform apply -target=aws_route53_record.dawgs-armageddon_cf_apex_alias[0]
```

---

## 4. Known States & Outstanding Items

| Item | Status | Notes |
|---|---|---|
| Service quota increase (VPC SG rules) | ⚠️ Pending | Requested 150. Current limit: 60. Once approved, consolidate dual SGs |
| ALB SG02 (HTTPS) ingress | ✅ | Locked to `pl-3b927c52` |
| CloudFront origin protocol | ✅ | `http-only` — intentional, SNI mismatch prevents `https-only` |
| Direct ALB access (HTTPS) | ✅ | SNI cert mismatch + 403 default listener. `--insecure` returns 403 |
| CloudFront path — app subdomain | ✅ | `https://app.thedawgs2025.click` returns 200, Via: CloudFront |
| CloudFront path — apex | ✅ | `https://thedawgs2025.click` returns 200, Via: CloudFront |
| WAF at CloudFront edge | ✅ | `lab-cf-waf01`, CLOUDFRONT scope, AWSManagedRulesCommonRuleSet active |
| DNS — apex | ✅ | Resolves to CloudFront IPs |
| DNS — app subdomain | ✅ | Resolves to CloudFront IPs (`52.222.205.x`) |
| Target health | ✅ | Healthy — `rdsapp` Flask service active on port 80 |
| Duplicate listener rules | ⚠️ | Priority 1 and 10 both forward on header match. Redundant but harmless. Clean up when convenient |

---

## 5. Operational Runbook

### 5.1 Lab Verification Checklist

Run after every `terraform apply`:

**Test 1 — Apex through CloudFront**
```bash
curl -I https://thedawgs2025.click
```
Expected: `HTTP/1.1 200 OK` with `Via: CloudFront`

**Test 2 — App subdomain through CloudFront**
```bash
curl -I https://app.thedawgs2025.click
```
Expected: `HTTP/1.1 200 OK` with `Via: CloudFront`

**Test 3 — Direct ALB must be blocked**
```bash
curl -I https://lab-alb01-1858042517.us-east-1.elb.amazonaws.com --insecure
```
Expected: `HTTP/1.1 403 Forbidden`, `Server: awselb/2.0`

> **Note:** Without `--insecure`, curl returns an SSL error (`SEC_E_WRONG_PRINCIPAL`) because the ALB cert covers `thedawgs2025.click`, not the ALB DNS name. This is expected and correct behavior — the SNI check fails before any HTTP exchange.

**Test 4 — DNS resolves to CloudFront**
```bash
nslookup thedawgs2025.click
nslookup app.thedawgs2025.click
```
Expected: Addresses in CloudFront IP ranges — not ALB IPs

---

### 5.2 Diagnosing 502 from CloudFront

**Step 1 — Check target health**
```bash
aws elbv2 describe-target-health \
  --target-group-arn arn:aws:elasticloadbalancing:us-east-1:778185677715:targetgroup/lab-tg01/8f142282efda225d
```
- `unhealthy + Target.Timeout` → EC2 SG missing inbound rule from ALB SG — go to Section 5.3
- `healthy` → proceed to Step 2

**Step 2 — Check ALB RequestCount**
```bash
aws cloudwatch get-metric-statistics \
  --namespace AWS/ApplicationELB \
  --metric-name RequestCount \
  --dimensions Name=LoadBalancer,Value=app/lab-alb01/f817462bee64fa50 \
  --start-time <ISO_START> --end-time <ISO_END> \
  --period 300 --statistics Sum
```
- `Sum = 0` → CloudFront never reached ALB — proceed to Step 3
- `Sum > 0` → ALB receiving but returning error — check listener rules

**Step 3 — Check ClientTLSNegotiationErrorCount**
```bash
aws cloudwatch get-metric-statistics \
  --namespace AWS/ApplicationELB \
  --metric-name ClientTLSNegotiationErrorCount \
  --dimensions Name=LoadBalancer,Value=app/lab-alb01/f817462bee64fa50 \
  --start-time <ISO_START> --end-time <ISO_END> \
  --period 300 --statistics Sum
```
- Errors present → TLS SNI mismatch → set `origin_protocol_policy = "http-only"`

**Step 4 — Verify origin secret is in sync**
```bash
aws cloudfront get-distribution --id E3VBKBF4IR3L08 \
  --query "Distribution.DistributionConfig.Origins.Items[*].CustomHeaders"
```
Note the `HeaderValue`. Then verify the ALB listener rule matches:
```bash
aws elbv2 describe-rules \
  --listener-arn <HTTPS_LISTENER_ARN> \
  --query "Rules[?Priority=='1'].Conditions"
```
Values must be identical. If not, run `terraform apply` to resync.

**Step 5 — Simulate CloudFront request directly to ALB**
```bash
curl -I http://lab-alb01-1858042517.us-east-1.elb.amazonaws.com \
  -H "X-Origin-Verify: <secret_value>"
```
- `200 OK` → ALB and app healthy, issue is upstream (CloudFront config or DNS)
- `403` → Listener rule not matching header — verify rule and secret value
- Timeout → SG blocking — check ALB SG ingress rules

---

### 5.3 Diagnosing Target.Timeout

**Step 1 — Verify app is running on EC2**
```bash
sudo systemctl status rdsapp
sudo ss -tlnp | grep python
```

**Step 2 — Test app responds locally**
```bash
curl -I http://localhost
```
Expected: `200 OK`

**Step 3 — Verify EC2 SG has inbound rules from both ALB SGs**
```bash
aws ec2 describe-security-groups \
  --filters "Name=group-name,Values=*ec2*" \
  --query "SecurityGroups[0].IpPermissions"
```
Must show `UserIdGroupPairs` entries for both `sg-0b3aa62b1416d41bb` and `sg-05f03fb98d911ab03`.

---

### 5.4 Checking SG Rule Quota

```bash
aws service-quotas get-service-quota \
  --service-code vpc \
  --quota-code L-0EA8095F \
  --query "Quota.Value"
```

Check pending increase requests:
```bash
aws service-quotas list-requested-service-quota-changes-by-service \
  --service-code vpc
```

> **Warning:** If a prefix list rule is accidentally added to `sg01` on port 443, the quota is exceeded and traffic silently drops. Verify `sg01` has only one rule (port 80) after any apply.

---

### 5.5 ALB Listener Rules Verification

```bash
aws elbv2 describe-rules \
  --listener-arn $(aws elbv2 describe-listeners \
    --load-balancer-arn arn:aws:elasticloadbalancing:us-east-1:778185677715:loadbalancer/app/lab-alb01/f817462bee64fa50 \
    --query "Listeners[?Port==\`443\`].ListenerArn" --output text) \
  --query "Rules[*].{Priority:Priority,Conditions:Conditions,Actions:Actions[0].Type}"
```

Expected:
- Priority `1`: `X-Origin-Verify` header match → `forward`
- Priority `10`: `X-Origin-Verify` header match → `forward` (redundant, from snippet)
- Priority `99`: `path-pattern *` → `fixed-response` 403 (redundant, from snippet)
- Priority `default`: no condition → `fixed-response` 403

---

### 5.6 WAF Verification

```bash
aws wafv2 get-web-acl \
  --name lab-cf-waf01 \
  --scope CLOUDFRONT \
  --id 87ca0e7e-1921-488f-ae0d-a5c1ed04faa9 \
  --region us-east-1 \
  --query "WebACL.Rules[*].{Name:Name,Priority:Priority}"

aws cloudfront get-distribution --id E3VBKBF4IR3L08 \
  --query "Distribution.DistributionConfig.WebACLId"
```

Expected: WAF ARN present on the distribution.

---

### 5.7 Force Destroy S3 Buckets with Logs

Add `force_destroy = true` to any S3 bucket resource before running `terraform destroy`:

```hcl
resource "aws_s3_bucket" "dawgs-armageddon_cf_logs_bucket01" {
  count         = var.enable_cloudfront && var.enable_cloudfront_logging ? 1 : 0
  bucket        = "${var.project_name}-cf-logs-${data.aws_caller_identity.dawgs-armageddon_self01.account_id}"
  force_destroy = true
  ...
}
```

Run `terraform apply` first to register the change, then `terraform destroy`.

---

## 6. Issue Reference Table

| Issue | Root Cause | Resolution |
|---|---|---|
| Apex domain bypassing CloudFront | Route53 apex A record still aliased to ALB after `app.` was moved to CloudFront | Added `aws_route53_record.dawgs-armageddon_cf_apex_alias` resource and `var.domain_name` to distribution aliases |
| Apex 403 from CloudFront | `thedawgs2025.click` not in distribution `aliases` list | Added `var.domain_name` to `aliases = [local.cf_fqdn, var.domain_name]` |
| Route53 record not updating despite being in state | Targeted apply needed to force update | `terraform apply -target=aws_route53_record.dawgs-armageddon_cf_apex_alias[0]` |
| `RulesPerSecurityGroupLimitExceeded` | `pl-3b927c52` has 45 CIDRs. Two prefix-list rules = 90 slots. Limit = 60 | Split into two SGs. Quota increase to 150 requested |
| `Target.Timeout` | EC2 SG missing inbound rules from both ALB SGs | Added ingress rules referencing both `alb_sg01` and `alb_sg02` |
| 502 Bad Gateway — `RequestCount = 0` | `ClientTLSNegotiationErrorCount` — SNI mismatch on CloudFront→ALB TLS | Set `origin_protocol_policy = "http-only"` |
| 301 Redirect loop | HTTP listener redirecting to HTTPS with ALB hostname in `Location` header | Changed HTTP listener `default_action` to `forward` |
| Secret mismatch after `random_password` introduced | CloudFront still sending old hardcoded secret; ALB expecting new random value during CF deployment window | Both `custom_header` and listener rule condition now reference `random_password` resource directly |

---

## 7. Terraform File Reference

| File | Purpose |
|---|---|
| `bonus_b.tf` | ALB, SGs (`sg01` + `sg02`), EC2 ingress rules, target group, listeners, ACM cert (ALB), WAF (regional) |
| `cloudfront-lab-2a-distribution.tf` | CloudFront distribution, ACM cert (CloudFront), ALB listener rule (priority 1), Route53 aliases (apex + app), CloudFront WAF (global) |
| `cloudfront-lab-2a-outputs.tf` | CloudFront distribution outputs |
| `cloudfront-variables.tf` | Variables: `cloudfront_subdomain`, `enable_cloudfront`, origin header name, WAF toggles, geo restriction |
| `lab2a-origin-cloaking-snippet.tf` | `random_password` resource, `aws_security_group_rule` (port 443), listener rules (priority 10 + 99) |

### 7.1 Critical Configuration Values

| Variable / Setting | Value | Reason |
|---|---|---|
| `origin_protocol_policy` | `http-only` | SNI mismatch with `https-only` causes `ClientTLSNegotiationErrorCount` |
| `cloudfront_origin_header_name` | `X-Origin-Verify` | Secret header name checked by ALB listener rule |
| Origin secret | `random_password.dawgs-armageddon_origin_header_value01.result` | Single source of truth — both CF and ALB reference same resource |
| ALB HTTP listener action | `forward` (not `redirect`) | Redirect causes loop when CloudFront hits port 80 |
| CloudFront prefix list | `pl-3b927c52` | AWS-managed CloudFront origin-facing IPs, us-east-1 (45 CIDRs) |
| Distribution aliases | `[local.cf_fqdn, var.domain_name]` | Both `app.thedawgs2025.click` and `thedawgs2025.click` must be listed |
| `evaluate_target_health` on CF alias | `false` | CloudFront does not support health-check evaluation on Route53 aliases |

---

*Armageddon Lab 2A — Session 2 complete. February 24, 2026.*