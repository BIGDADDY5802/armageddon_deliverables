Armageddon Worksheet

VPC: armageddon-demo
Subnet Name: Public 2 - Private 2

Instance Name: lab-ec2-app

Database: lab-mysql

VPC CIDR: 10.190.0.0/16

Subnet CIDRs: public - 10.190.1.0/24, 10.190.2.0/24 
              private - 10.190.11.0/24, 10.190.12.0/24


Security groups: sg-ec2-lab: armageddon-public-sg - sg-ec2-lab for TCP 3306: armageddon-db-sg


Create a private vpc

Create security groups:
-	sg-ec2-lab: armageddon-public-sg > HTTP > SSH from My IP <>
-	sg-ec2-lab for TCP 3306: armageddon-db-sg: <armageddon-private-subnet>


create instance:
-	name: lab-ec2-app
-	key pair: armageddon-lab-1
-	Security group: armageddon-public-sg
-	use Armageddon user_data.sh copy raw > Paste in user data
-	Create Instance 3.238.149.70


Create IAM role for instance to access database:
-	Custom Trust Policy



```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "ReadSpecificSecret",
      "Effect": "Allow",
      "Action": ["secretsmanager:GetSecretValue"],
      "Resource": "arn:aws:secretsmanager:<REGION>:<ACCOUNT_ID>:secret:lab/rds/mysql*"
    }
  ]
}
```

This policy gave an error of missing principal and role trust policy Syntax Error Resource

```
 
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "ec2.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    },
    {
      "Sid": "ReadSpecificSecret",
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": "arn:aws:secretsmanager:<REGION>:<ACCOUNT_ID>:secret:lab/rds/mysql*"
    }
  ]
}
create database:
-	Aurora Database: lab-mysql > full configuration > MySQL > MySQL 8.4.7 > dev/test > 2 azs > 
admin (username) > self managed > easy password until we create secrets manager configuration (DawgsRDSPass123) > 
General purpose > Not connecting to instance yet (there isn't one) > public access no > Already created database security group > 
choose existing sg > us-east -1 >Port 3306 > Tag
{KMS key ID
alias/aws/rds}

-	Note: Has to be at least 2 AZs to create Aurora MySQL Database Databases are managed


destroy database:
```bash
aws rds delete-db-instance --db-instance-identifier\
'labmysql' --final-db-snapshot-identifier 'labmysql-snapshot' 
```


secrets manager: 
-	credentials for Amazon RDS Database
-	Credentials un: admin pw: DawgsRDSPass123
-	Whatever name you have for the secret name it must be in the script. Default is <"lab/rds/mysql">
-	Description: Access credentials for MySQL rds database


Create IAM role for instance to access database:
-	Custom Trust Policy



```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "ReadSpecificSecret",
      "Effect": "Allow",
      "Action": ["secretsmanager:GetSecretValue"],
      "Resource": "arn:aws:secretsmanager:<REGION>:<ACCOUNT_ID>:secret:lab/rds/mysql*"
    }
  ]
}
```

This policy gave an error of missing principal and role trust policy Syntax Error Resource

```
 
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "ec2.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    },
    {
      "Sid": "ReadSpecificSecret",
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue"
      ],
      "Resource": "arn:aws:secretsmanager:<REGION>:<ACCOUNT_ID>:secret:lab/rds/mysql*"
    }
  ]
}
```

We had permissions for the role but no principal. Therefore the policy was incomplete.

Also noticed in TF jsonencode function the policies were different...

Add a Principal element to the policy.

Role Trust policies apply to the role that they are attached to. You cannot specify a resource. Remove the Resource or NotResource element. 

Chose a broad policy with read and write permissions and changed the permissions in the policy to make them more inline. Could have just created a policy and attached to Role so the EC2 can assume the role...
Go to Polciy > Create Policy > Go to JSON and paste Theo code.

```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "ReadSpecificSecret",
      "Effect": "Allow",
      "Action": ["secretsmanager:GetSecretValue"],
      "Resource": "arn:aws:secretsmanager:<REGION>:<ACCOUNT_ID>:secret:lab/rds/mysql*"
    }
  ]
}
```
Change your region and account number

Go to create role > make it for ec2 > name it > the search your policy > 'secrets_manger_get_secret' > 

So after we make the policy we select the policy after we create the role.

Source: <https://docs.aws.amazon.com/secretsmanager/latest/userguide/auth-and-access_resource-policies.html>

<https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_principal.html#Principal_specifying>

As we forgot the enable public IP on instance one we then created a second instance to attach the role.

Couldn't connect to the Database through the instance with init. now we troubleshoot.
0 connections to database. What's the issue?

Go to IAM and create



Found we needed to make ec2 connection to with database.
Made connection with database and there was no http access or ssh access.
changed from my IP to 0.0.0.0/0 and still no connection.

<RDS_ENDPOINT>

mysql -h dawgs-armageddon-rds01.c89ykq22i31z.us-east-1.rds.amazonaws.com -u admin -p

DawgsRDSPass123

SHOW DATABASES;

CREATE DATABASE labdb;

exit

sudo systemctl restart rdsapp

http://<EC2_PUBLIC_IP>/list
http://<EC2_PUBLIC_IP>/add?note=first_note
http://<EC2_PUBLIC_IP>/init
add?note=DAWGS_click_ops_on_point_now_to_terraform

mysql -h <RDS_ENDPOINT> -u admin -p
SHOW DATABASES;
CREATE DATABASE labdb;
SHOW DATABASES;
exit
